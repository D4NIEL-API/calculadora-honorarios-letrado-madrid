<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CALCULADORA HONORARIOS LETRADO (ICAM) POR DBS</title>
    <!-- React y Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- FontAwesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', system-ui, sans-serif; background-color: #f1f5f9; }
        
        /* Botones Modo */
        .mode-btn-active { 
            background-color: #1e3a8a; 
            color: #ffffff; 
            border: 1px solid #1e3a8a;
            box-shadow: 0 4px 6px -1px rgba(30, 58, 138, 0.4); 
            font-weight: 700;
        }
        .mode-btn-inactive { 
            background-color: white; 
            color: #475569; 
            border: 1px solid #cbd5e1; 
        }
        .mode-btn-inactive:hover { 
            background-color: #f8fafc; 
            border-color: #94a3b8;
            color: #1e293b;
        }

        .scenario-btn { transition: all 0.2s; }
        .scenario-btn:hover { transform: translateY(-1px); }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Chat Styles */
        .chat-container { height: 400px; display: flex; flex-direction: column; }
        .chat-bubble { max-width: 85%; padding: 10px 14px; border-radius: 12px; font-size: 0.85rem; line-height: 1.5; margin-bottom: 8px; }
        .chat-user { background-color: #1e3a8a; color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
        .chat-ai { background-color: #f1f5f9; color: #334155; border: 1px solid #e2e8f0; align-self: flex-start; border-bottom-left-radius: 2px; }
        
        .typing-dot { width: 5px; height: 5px; background: #94a3b8; border-radius: 50%; animation: typing 1.4s infinite ease-in-out both; margin: 0 2px; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        /* Slider & Tooltip */
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #1e3a8a; cursor: pointer; margin-top: -6px; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #cbd5e1; border-radius: 2px; }
        .tooltip { visibility: hidden; width: 220px; background-color: #334155; color: #fff; text-align: center; border-radius: 6px; padding: 8px; position: absolute; z-index: 50; bottom: 125%; left: 50%; margin-left: -110px; opacity: 0; transition: opacity 0.3s; font-size: 11px; font-weight: normal; line-height: 1.4; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .has-tooltip:hover .tooltip { visibility: visible; opacity: 1; }
        .tooltip::after { content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px; border-width: 5px; border-style: solid; border-color: #334155 transparent transparent transparent; }
        
        .markdown-chat p { margin-bottom: 0.5em; }
        .markdown-chat ul { list-style-type: disc; padding-left: 1.2em; margin-bottom: 0.5em; }
        .markdown-chat strong { font-weight: 700; color: #1e3a8a; }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- GEMINI API SETUP ---
        // CLAVE API INTEGRADA (NO EDITABLE POR EL USUARIO)
        const API_KEY = "AIzaSyADKaOvm_B54-VZ_b8sJEdo194s6c3Jw0k"; 

        // --- CONTEXTO JURÍDICO COMPLETO (Extracto Completo ICAM 2013) ---
        const ICAM_CONTEXT = `
        DOCUMENTO OFICIAL: CRITERIOS ORIENTADORES DE HONORARIOS DEL ILUSTRE COLEGIO DE ABOGADOS DE MADRID (ICAM), APROBADOS EL 4 DE JULIO DE 2013.

        --- 1. CONSIDERACIONES GENERALES ---
        PRIMERA.- Presupuesto/Hoja de Encargo: Se recomienda su uso.
        SEGUNDA.- Bases para determinación: Trabajo realizado, complejidad, cuantía, tiempo, especialización.
        TERCERA.- Determinación de la cuantía:
        - Interés económico del asunto. Si es inestimable: 18.000 €.
        - Reconvención: Si objeto distinto, se suman cuantías. Si mismo objeto, se aplica Escala una sola vez con incremento hasta 50%.
        - Acumulación acciones: Suma de cuantías.
        CUARTA.- Escala y valor razonable: Porcentajes decrecientes. Se puede modular según trabajo efectivo.
        QUINTA.- Terminación anormal: 
        - Allanamiento/Desistimiento: Atemperar honorarios (aprox. 50-60% según momento).
        - Transacción Judicial: Hasta 30% de la Escala sobre la base económica, además de lo que proceda por el trabajo realizado.
        SEXTA.- Costas Procesales: El condenado reembolsa según estos criterios, no según lo pactado entre abogado y cliente.
        SÉPTIMA.- Pluralidad de interesados: Si actúan bajo distintas direcciones letradas con misma acción, se divide una minuta ideal entre el número de letrados (pudiendo modularse).

        --- 2. ESCALA GENERAL (Base de Cálculo Acumulativa) ---
        - Hasta 4.000 €: 25% (Cuota: 1.000€)
        - Exceso hasta 18.000 €: 18% (Acumulado: 3.520€)
        - Exceso hasta 30.000 €: 16% (Acumulado: 5.440€)
        - Exceso hasta 45.000 €: 14% (Acumulado: 7.540€)
        - Exceso hasta 60.000 €: 12% (Acumulado: 9.340€)
        - Exceso hasta 90.000 €: 10% (Acumulado: 12.340€)
        - Exceso hasta 120.000 €: 9% (Acumulado: 15.040€)
        - Exceso hasta 180.000 €: 8% (Acumulado: 19.840€)
        - Exceso hasta 240.000 €: 7% (Acumulado: 24.040€)
        - Exceso hasta 300.000 €: 6% (Acumulado: 27.640€)
        - Exceso hasta 450.000 €: 5,5% (Acumulado: 35.890€)
        - Exceso hasta 600.000 €: 5,0% (Acumulado: 43.390€)
        - Exceso hasta 750.000 €: 4,5% (Acumulado: 50.140€)
        - Exceso hasta 900.000 €: 4,0% (Acumulado: 56.140€)
        - Exceso hasta 1.050.000 €: 3,5% (Acumulado: 61.390€)
        - Exceso hasta 1.200.000 €: 3,0% (Acumulado: 65.890€)
        - Exceso hasta 1.500.000 €: 2,5% (Acumulado: 73.390€)
        - Exceso hasta 1.800.000 €: 2,0% (Acumulado: 79.390€)
        - Exceso hasta 2.100.000 €: 1,5% (Acumulado: 83.890€)
        - Exceso hasta 2.400.000 €: 1,0% (Acumulado: 86.890€)
        - Exceso hasta 2.700.000 €: 0,5% (Acumulado: 88.390€)
        * A partir de 2.700.000€ se gradúa con prudencia.

        --- 3. CRITERIOS ESPECÍFICOS ---
        
        TÍTULO I: JURISDICCIÓN CIVIL
        Criterio 1 (Diligencias Preliminares): Escala sobre caución o 15% del pleito principal.
        Criterio 2 (Incidentes): 20% de la Escala (Min 450€). 
           - Impugnación Tasación Excesivos: Ref 100€ (fijo). 
           - Indebidos: 20% Escala sobre partida discutida (Min 450€).
        Criterio 3 (Arbitraje): 30% Escala formalización, 10% oposición.
        Criterio 4 (Juicio Ordinario): Escala completa. Valor Referencia 2.100€. Distribución: 50% alegaciones, 20% audiencia, 30% juicio.
        Criterio 5 (Juicio Verbal): Escala completa. Valor Referencia 1.200€. Distribución: 50% demanda, 50% juicio.
           - Desahucios (5.2): 
             * A) Enervación: 50% Escala sobre cantidad satisfecha (Ref 600€).
             * B) Sin oposición (paga/desaloja): 50% Escala sobre cantidades debidas (Ref 600€).
             * C) Con oposición y vista: 100% Escala sobre anualidad renta (Ref 900€).
        Criterio 6 (Reposición/Revisión): Ref 300€ o 10% Escala.
        Criterio 7 (Apelación): 50% de la Escala (o 50% de lo que correspondía en instancia). Min 1.200€. +25% si hay prueba, +25% si hay vista.
        Criterio 8 (Extraordinario Infracción Procesal): 75% Escala. Min 2.400€.
        Criterio 9 (Casación): 85% Escala. Min 3.200€.
        Criterio 15 (Ejecuciones): 
           - A) Dineraria Judicial:
             * 2. Apremio sin oposición: Hasta 75% Escala.
             * 3. Con oposición: 50% Escala (Min 1.200€).
             * 4. Íntegra (con subasta) con oposición: 100% Escala. Sin oposición: 75%.
           - C) Título No Judicial: Sin oposición 50% Escala (Ref 600€).
           - D) Hipotecaria: Base es la MENOR entre Deuda Reclamada y Responsabilidad Hipotecaria. 75% sin op, 100% con op. Min 1.200€.
        Criterio 16 (Cautelares): 30% Escala sobre interés medidas.
        Criterio 18 (Familia):
           - Mutuo Acuerdo: Ref 1.500€. (+50% si convenio complejo/liquidación).
           - Contencioso: Ref 2.500€. Si hay discusión económica >9.000€, sumar escala sobre diferencia.
           - Modificación Medidas: Ref 1.500€. Escala sobre diferencia anualidad pensiones.
        Criterio 23 (Monitorio): 
           - Sin oposición (y sin pago): Ref 400€. 
           - Con pago (<30k): 50% Escala. (>30k): 25% Escala.
        Criterio 24 (Cambiario): Sin oposición 25%. Con oposición 50%.
        
        TÍTULO II: JURISDICCIÓN PENAL
        Criterio 35 (Instrucción): Abreviado Ref 550€. Sumario 800€.
        Criterio 37 (Juicio Oral): Ref 650€ + 300€/sesión extra. Conformidad reduce 30%.
        Criterio 85 (Responsabilidad Civil en Instancia): 70% de la Escala Civil sobre la indemnización. (Si archivo 50% red., si conformidad 25-50% red.).
        Criterio 86 (Responsabilidad Civil en Recursos): 
           - Apelación: 50% de lo correspondiente a la instancia.
           - Casación: 85% del 70% de la Escala.
        
        TÍTULO III: CONTENCIOSO-ADMINISTRATIVO
        Criterio 89 (Ordinario): Escala completa. Min 2.100€.
        Criterio 90 (Abreviado): Escala completa. Min 1.200€. (Multas/Extranjería Min 600€).
        Criterio 93 (Apelación): 50% Escala. Min 1.200€.
        
        TÍTULO IV: SOCIAL
        Criterio 99 (Cantidad): Escala sobre reclamado. Min 600€.
        Criterio 101 (Despido): Escala sobre Indemnización + Salarios tramitación. Min 900€.
        Criterio 109 (Suplicación): 50% Escala. Min 1.200€.
        
        NOTA LEGAL ADICIONAL: En las tasaciones de costas a la parte vencida, el art. 394.3 de la LEC limita el importe total de abogados y peritos a la tercera parte (1/3) de la cuantía del procedimiento, salvo que el tribunal declare la temeridad del litigante.
        `;

        // Función para consultar a la API de Gemini
        async function chatWithGemini(messages) {
            try {
                const contents = messages.map(msg => ({
                    role: msg.role === 'user' ? 'user' : 'model',
                    parts: [{ text: msg.content }]
                }));

                const lastMsgIndex = contents.length - 1;
                const userQuery = contents[lastMsgIndex].parts[0].text;
                
                // Prompt de Sistema (Contexto Inyectado)
                const prompt = `
                    ACTÚA COMO UN EXPERTO LETRADO DEL ICAM.
                    
                    CONTEXTO JURÍDICO (CRITERIOS 2013):
                    ${ICAM_CONTEXT}
                    
                    INSTRUCCIÓN: Responde basándote EXCLUSIVAMENTE en el texto anterior.
                    - Cita el Criterio específico (número).
                    - Sé breve y profesional.
                    
                    PREGUNTA DEL USUARIO: "${userQuery}"
                `;
                
                contents[lastMsgIndex].parts[0].text = prompt;

                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${API_KEY}`,
                    {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ contents })
                    }
                );
                
                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.error?.message || "API Error");
                }
                
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "Lo siento, no pude procesar la consulta.";
            } catch (error) {
                console.error("Gemini Error:", error);
                return "Hubo un error de conexión con el servidor de IA.";
            }
        }

        // --- DATOS ESTÁTICOS ---
        const SCALE_2013 = [
            { limit: 4000, percent: 25 }, { limit: 18000, percent: 18 }, { limit: 30000, percent: 16 }, 
            { limit: 45000, percent: 14 }, { limit: 60000, percent: 12 }, { limit: 90000, percent: 10 }, 
            { limit: 120000, percent: 9 }, { limit: 180000, percent: 8 }, { limit: 240000, percent: 7 }, 
            { limit: 300000, percent: 6 }, { limit: 450000, percent: 5.5 }, { limit: 600000, percent: 5 }, 
            { limit: 750000, percent: 4.5 }, { limit: 900000, percent: 4 }, { limit: 1050000, percent: 3.5 }, 
            { limit: 1200000, percent: 3 }, { limit: 1500000, percent: 2.5 }, { limit: 1800000, percent: 2 }, 
            { limit: 2100000, percent: 1.5 }, { limit: 2400000, percent: 1 }, { limit: 2700000, percent: 0.5 }
        ];

        const MODES = {
            CIVIL: { id: 'CIVIL', label: 'Civil / Mercantil', icon: 'fa-scale-balanced', color: 'text-blue-600' },
            PENAL: { id: 'PENAL', label: 'Penal', icon: 'fa-gavel', color: 'text-red-600' },
            CONTENCIOSO: { id: 'CONTENCIOSO', label: 'Contencioso-Adm.', icon: 'fa-building-columns', color: 'text-orange-600' },
            SOCIAL: { id: 'SOCIAL', label: 'Social (Laboral)', icon: 'fa-users', color: 'text-green-600' },
        };

        const PROCEDURES = {
            CIVIL: [
                { category: 'Declarativos' },
                { id: 'c4_ordinario', label: 'Juicio Ordinario (Criterio 4)', min: 2100, mod: 100, explanation: 'Tramitación íntegra. Criterio 4.' },
                { id: 'c5_verbal', label: 'Juicio Verbal (Criterio 5)', min: 1200, mod: 100, explanation: 'Tramitación íntegra. Criterio 5.' },
                { id: 'c5_desahucio_no_op', label: 'Desahucio (Sin Oposición)', min: 600, mod: 50, explanation: 'Reducción al 50% por falta de oposición. Criterio 5.2.B.' },
                { id: 'c5_desahucio_op', label: 'Desahucio (Con Vista)', min: 900, mod: 100, explanation: '100% Escala al celebrarse vista. Criterio 5.2.C.' },
                { id: 'c23_monitorio', label: 'Monitorio (Sin Oposición)', min: 400, mod: 25, explanation: 'Se aplica prudencialmente 25% Escala o fijo 400€. Criterio 23.' },
                { id: 'c24_cambiario', label: 'Cambiario (Con Oposición)', min: 1200, mod: 50, explanation: 'Solo fase de oposición. Criterio 24.' },
                { id: 'c18_familia', label: 'Familia (Contencioso)', min: 2500, mod: 0, isFixedBase: true, explanation: 'Base fija de referencia. Criterio 18.' },
                { category: 'Ejecuciones' },
                { id: 'c15_ejec_din_op', label: 'Ejec. Dineraria (Con Oposición)', min: 1200, mod: 50, explanation: '50% Escala si hay oposición/consignación. Criterio 15.A.3.' },
                { id: 'c15_ejec_din_integra', label: 'Ejec. Vía Apremio (Completa)', min: 1200, mod: 75, explanation: '75% Escala sin oposición (hasta subasta). Criterio 15.A.4.' },
                { id: 'c15_hipotecario', label: 'Ejecución Hipotecaria', min: 1200, mod: 75, explanation: 'Base: Menor entre Deuda y Resp. Hipotecaria. Criterio 15.D.' },
                { id: 'c15_tit_no_jud', label: 'Ejec. Título No Judicial', min: 600, mod: 50, explanation: '50% Escala sin oposición. Criterio 15.C.' },
                { category: 'Recursos' },
                { id: 'c7_apelacion', label: 'Apelación (Audiencia Provincial)', min: 1200, mod: 50, explanation: '50% de la Escala. Criterio 7.' },
                { id: 'c9_casacion', label: 'Casación / Extraordinario', min: 3200, mod: 85, explanation: '85% de la Escala. Criterio 9.' },
                { category: 'Incidentes' },
                { id: 'c2_incidente', label: 'Incidente / Tasación Costas', min: 450, mod: 20, explanation: '20% de la Escala. Criterio 2.' },
            ],
            PENAL: [
                { id: 'c85_rc_instancia', label: 'Resp. Civil en Sentencia', min: 0, mod: 70, explanation: '70% de la Escala sobre la indemnización. Criterio 85.' },
                { id: 'c86_rc_apelacion', label: 'Resp. Civil en Apelación', min: 0, mod: 35, explanation: '50% de lo correspondiente a la instancia. Criterio 86.' },
            ],
            CONTENCIOSO: [
                { id: 'c89_ordinario', label: 'Procedimiento Ordinario', min: 2100, mod: 100, explanation: 'Tramitación íntegra. Criterio 89.' },
                { id: 'c90_abreviado', label: 'Procedimiento Abreviado', min: 1200, mod: 100, explanation: 'Sobre cuantía o interés económico. Criterio 90.' },
                { id: 'c93_apelacion_cont', label: 'Apelación Contencioso', min: 1200, mod: 50, explanation: '50% de la Escala. Criterio 93.D.' },
            ],
            SOCIAL: [
                { id: 'c99_cantidad', label: 'Reclamación de Cantidad', min: 600, mod: 100, explanation: 'Aplicación de la Escala. Criterio 99.' },
                { id: 'c101_despido', label: 'Despido', min: 900, mod: 100, explanation: 'Escala sobre Indemnización + Salarios. Criterio 101.' },
                { id: 'c109_suplicacion', label: 'Recurso de Suplicación', min: 1200, mod: 50, explanation: '50% de la Escala. Criterio 109.' },
            ]
        };

        const SCENARIOS = [
            { pct: 100, label: 'Tramitación Completa', desc: 'Caso estándar: Todas las fases hasta sentencia.', color: 'bg-green-50 text-green-700 border-green-200' },
            { pct: 60, label: 'Transacción (Acuerdo)', desc: 'Terminación por acuerdo homologado (aprox 60%).', color: 'bg-blue-50 text-blue-700 border-blue-200' },
            { pct: 50, label: 'Allanamiento / Desist.', desc: 'Terminación anormal antes de juicio (50%).', color: 'bg-orange-50 text-orange-700 border-orange-200' },
            { pct: 25, label: 'Terminación Inicial', desc: 'Terminación en fase muy temprana.', color: 'bg-red-50 text-red-700 border-red-200' }
        ];

        const getAmountHelp = (mode, procId) => {
            if (!procId) return "Seleccione un procedimiento.";
            if (mode === 'EJECUCION') return "Principal + Intereses + Costas (aprox +30%). Hipotecaria: la menor entre Deuda y Resp. Hipot.";
            if (mode === 'RECURSOS') return "Interés económico del recurso (gravamen).";
            if (mode === 'CIVIL') return procId.includes('desahucio') ? "1 Anualidad Renta + Deuda." : "Principal reclamado.";
            return "Importe económico del litigio.";
        };

        // --- CHAT COMPONENT ---
        function ChatEmbedded() {
            const [messages, setMessages] = useState([
                { role: 'model', content: 'Hola, soy tu asistente experto en Criterios ICAM 2013. Pregúntame sobre cualquier duda de tasación (Ej: "¿Cuánto es el mínimo de un Ordinario?").' }
            ]);
            const [inputValue, setInputValue] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const messagesEndRef = useRef(null);

            const scrollToBottom = () => {
                messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
            };

            useEffect(() => {
                scrollToBottom();
            }, [messages]);

            const handleSend = async (e) => {
                e.preventDefault();
                if (!inputValue.trim()) return;

                const newMessages = [...messages, { role: 'user', content: inputValue }];
                setMessages(newMessages);
                setInputValue('');
                setIsLoading(true);

                // Usamos la API Key integrada
                const responseText = await chatWithGemini(newMessages);
                
                setMessages(prev => [...prev, { role: 'model', content: responseText }]);
                setIsLoading(false);
            };

            return (
                <div className="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden flex flex-col h-[450px] mt-6 relative">
                    {/* Header */}
                    <div className="bg-slate-800 text-white p-3 border-b border-slate-700 flex justify-between items-center">
                        <h3 className="font-bold text-sm flex items-center"><i className="fas fa-robot mr-2 text-blue-400"></i> Asistente</h3>
                    </div>
                    
                    {/* Messages */}
                    <div className="flex-1 overflow-y-auto p-4 bg-slate-50 space-y-3 custom-scrollbar">
                        {messages.map((msg, idx) => (
                            <div key={idx} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                <div className={`chat-bubble ${
                                    msg.role === 'user' 
                                    ? 'chat-user shadow-md' 
                                    : 'chat-ai shadow-sm markdown-chat'
                                }`}>
                                    {msg.role === 'model' 
                                        ? <div dangerouslySetInnerHTML={{ __html: marked.parse(msg.content) }} />
                                        : msg.content
                                    }
                                </div>
                            </div>
                        ))}
                        {isLoading && (
                            <div className="flex justify-start">
                                <div className="bg-white border border-slate-200 rounded-2xl rounded-bl-none p-3 shadow-sm flex gap-1">
                                    <div className="typing-dot"></div><div className="typing-dot"></div><div className="typing-dot"></div>
                                </div>
                            </div>
                        )}
                        <div ref={messagesEndRef} />
                    </div>

                    {/* Input */}
                    <form onSubmit={handleSend} className="p-3 bg-white border-t border-slate-200">
                        <div className="relative">
                            <input
                                type="text"
                                value={inputValue}
                                onChange={(e) => setInputValue(e.target.value)}
                                placeholder="Escribe tu consulta..."
                                className="w-full pl-4 pr-10 py-2 bg-slate-100 border-none rounded-full text-xs focus:ring-2 focus:ring-blue-500 focus:bg-white transition-all outline-none"
                            />
                            <button 
                                type="submit" 
                                disabled={!inputValue.trim() || isLoading}
                                className="absolute right-1 top-1 w-7 h-7 bg-blue-600 text-white rounded-full flex items-center justify-center hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all shadow-sm"
                            >
                                <i className="fas fa-paper-plane text-xs"></i>
                            </button>
                        </div>
                    </form>
                </div>
            );
        }

        // --- PASSWORD SCREEN ---
        function LoginScreen({ onLogin }) {
            const [password, setPassword] = useState("");
            const [error, setError] = useState(false);

            const handleSubmit = (e) => {
                e.preventDefault();
                if (password === "DBS26") {
                    onLogin();
                } else {
                    setError(true);
                    setPassword("");
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-100 p-4">
                    <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm border border-slate-200 text-center">
                        <div className="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-6 text-blue-600 text-2xl"><i className="fas fa-lock"></i></div>
                        <h2 className="text-xl font-bold text-slate-800 mb-2">Acceso Restringido</h2>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <input type="password" value={password} onChange={(e) => { setPassword(e.target.value); setError(false); }} placeholder="Contraseña" className={`w-full p-3 rounded-lg border text-center font-mono outline-none focus:ring-2 transition-all ${error ? 'border-red-300 bg-red-50 focus:ring-red-200' : 'border-slate-300 focus:border-blue-500 focus:ring-blue-200'}`} />
                            {error && <p className="text-red-500 text-xs mt-2 animate-pulse">Contraseña incorrecta</p>}
                            <button type="submit" className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-transform transform active:scale-95">Entrar</button>
                        </form>
                    </div>
                </div>
            );
        }

        function App() {
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [jurisdiction, setJurisdiction] = useState('CIVIL');
            const [selectedProcId, setSelectedProcId] = useState('c4_ordinario'); 
            const [amount, setAmount] = useState('');
            const [customMod, setCustomMod] = useState(100);
            const [selectedScenario, setSelectedScenario] = useState(SCENARIOS[0]);
            const [includeVAT, setIncludeVAT] = useState(true);
            const [details, setDetails] = useState(null);

            useEffect(() => {
                const firstProc = PROCEDURES[jurisdiction].find(p => p.id);
                if (firstProc) setSelectedProcId(firstProc.id);
                setCustomMod(100);
                setSelectedScenario(SCENARIOS[0]);
            }, [jurisdiction]);

            const currentProcedure = useMemo(() => {
                return PROCEDURES[jurisdiction].find(p => p.id === selectedProcId) || {};
            }, [jurisdiction, selectedProcId]);

            const amountHelpText = useMemo(() => getAmountHelp(jurisdiction, selectedProcId), [jurisdiction, selectedProcId]);

            const handleSliderChange = (e) => {
                const val = Number(e.target.value);
                setCustomMod(val);
                const match = SCENARIOS.find(s => s.pct === val);
                if (match) setSelectedScenario(match);
                else setSelectedScenario({ pct: val, label: 'Personalizado', desc: `Ajuste manual al ${val}% definido por el usuario.`, color: 'bg-gray-50 text-gray-700' });
            };

            const handleScenarioClick = (scenario) => {
                setCustomMod(scenario.pct);
                setSelectedScenario(scenario);
            };

            // CORE CALCULATION
            useEffect(() => {
                if (!currentProcedure.id) return;
                const numericAmount = parseFloat(amount) || 0;
                const oneThirdLimit = (numericAmount > 0) ? (numericAmount / 3) : Infinity;

                if (currentProcedure.isFixedBase) {
                    const base = currentProcedure.min;
                    const adjustedBase = base * (customMod / 100);
                    let finalBase = adjustedBase > oneThirdLimit ? oneThirdLimit : adjustedBase;
                    const capped = adjustedBase > oneThirdLimit;
                    const vat = finalBase * 0.21;
                    
                    setDetails({
                        breakdown: [], scaleTotal: 0, reducedByCrit: base, minApplied: false, effectiveMin: base,
                        preCapBase: adjustedBase, finalBase, cappedByLimit: capped, oneThirdLimit, vat,
                        grandTotal: includeVAT ? finalBase + vat : finalBase
                    });
                    return;
                }

                let remaining = numericAmount;
                let scaleAccumulator = 0;
                let breakdownList = [];
                let prevLimit = 0;

                for (let tier of SCALE_2013) {
                    if (remaining <= 0) break;
                    let amountInTier = (tier.limit === 2700000 && numericAmount > 2700000) ? numericAmount - prevLimit : (amountInTier = (numericAmount > tier.limit) ? (tier.limit - prevLimit) : (numericAmount - prevLimit));
                    const fee = amountInTier * (tier.percent / 100);
                    if (amountInTier > 0) {
                        breakdownList.push({ range: `${prevLimit.toLocaleString()} - ${tier.limit === 2700000 ? '...' : tier.limit.toLocaleString()}`, pct: tier.percent, amount: amountInTier, fee: fee });
                        scaleAccumulator += fee;
                        remaining -= amountInTier;
                    }
                    prevLimit = tier.limit;
                }

                const valueAfterCriteria = scaleAccumulator * (currentProcedure.mod / 100);
                const valueAfterManualMod = valueAfterCriteria * (customMod / 100);
                let effectiveMin = currentProcedure.min * (currentProcedure.mod >= 100 ? 1 : currentProcedure.mod/100) * (customMod/100);
                if (effectiveMin < 100 && numericAmount > 0) effectiveMin = 100;

                let calculatedBase = valueAfterManualMod;
                let minApplied = false;
                if (calculatedBase < effectiveMin && numericAmount > 0) { calculatedBase = effectiveMin; minApplied = true; }

                let finalBase = calculatedBase;
                let capped = false;
                if (finalBase > oneThirdLimit) { finalBase = oneThirdLimit; capped = true; }

                const vat = finalBase * 0.21;
                setDetails({ breakdown: breakdownList, scaleTotal: scaleAccumulator, reducedByCrit: valueAfterCriteria, effectiveMin, minApplied, preCapBase: calculatedBase, finalBase, cappedByLimit: capped, oneThirdLimit, vat, grandTotal: includeVAT ? finalBase + vat : finalBase });

            }, [amount, currentProcedure, customMod, includeVAT]);

            if (!isAuthenticated) return <LoginScreen onLogin={() => setIsAuthenticated(true)} />;

            return (
                <div className="flex justify-center p-4 min-h-screen pb-20 fade-in">
                    <div className="w-full max-w-7xl grid grid-cols-1 lg:grid-cols-12 gap-6">
                        
                        {/* LEFT COLUMN */}
                        <div className="lg:col-span-3 space-y-4">
                            {/* TITLE CARD - UPDATED DESIGN */}
                            <div className="bg-white rounded-xl shadow-lg border-2 border-blue-600 p-6 text-center transform hover:scale-[1.01] transition-transform">
                                <h1 className="font-extrabold text-slate-900 text-xl uppercase leading-tight tracking-tight">
                                    CALCULADORA HONORARIOS LETRADO<br/>
                                    <span className="text-blue-700">(MADRID)</span> POR DBS
                                </h1>
                                <div className="h-1 w-16 bg-blue-600 mx-auto my-3 rounded-full"></div>
                                <p className="text-xs text-slate-500 font-medium uppercase tracking-widest">Criterios 2013</p>
                            </div>
                            
                            <nav className="space-y-2">
                                <p className="text-[10px] font-bold text-slate-400 uppercase tracking-wider px-3">Selecciona Jurisdicción</p>
                                {Object.values(MODES).map((m) => (
                                    <button
                                        key={m.id}
                                        onClick={() => setJurisdiction(m.id)}
                                        className={`w-full text-left px-4 py-3 rounded-lg text-sm transition-all flex items-center border ${jurisdiction === m.id ? 'mode-btn-active' : 'mode-btn-inactive'}`}
                                    >
                                        <i className={`fas ${m.icon} w-6 text-center mr-3 opacity-90`}></i>
                                        {m.label}
                                    </button>
                                ))}
                            </nav>

                            <div className="bg-slate-100 p-4 rounded-xl border border-slate-200 text-[11px] text-slate-500">
                                <strong>Nota Legal:</strong><br/>
                                Se aplica automáticamente el límite del art. 394.3 LEC (un tercio de la cuantía) para la tasación de costas contra la parte vencida.
                            </div>
                        </div>

                        {/* CENTER COLUMN */}
                        <div className="lg:col-span-5 space-y-6">
                            
                            {/* PANEL 1: DATOS */}
                            <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                                <h2 className="text-sm font-bold text-slate-800 uppercase mb-4 border-b pb-2 flex items-center">
                                    <span className="bg-slate-200 text-slate-600 rounded-full w-5 h-5 flex items-center justify-center text-xs mr-2">1</span>
                                    Datos del Asunto
                                </h2>
                                
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium text-slate-600 mb-1">Procedimiento / Trámite</label>
                                        <select 
                                            value={selectedProcId || ''}
                                            onChange={(e) => setSelectedProcId(e.target.value)}
                                            className="w-full p-2.5 bg-slate-50 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none"
                                        >
                                            {PROCEDURES[jurisdiction].map((p, idx) => (
                                                p.category ? 
                                                <optgroup key={idx} label={p.category} className="font-bold text-slate-400 bg-white" /> :
                                                <option key={p.id} value={p.id} className="text-slate-700 py-1">{p.label}</option>
                                            ))}
                                        </select>
                                        <p className="text-xs text-slate-500 mt-1 italic pl-1">{currentProcedure.explanation}</p>
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium text-slate-600 mb-1 flex justify-between">
                                            <span>
                                                {jurisdiction === 'PENAL' ? 'Cuantía Resp. Civil (€)' : 
                                                 jurisdiction === 'SOCIAL' && selectedProcId === 'c101_despido' ? 'Indemnización + Salarios (€)' :
                                                 'Cuantía / Interés Económico (€)'}
                                            </span>
                                            
                                            <div className="has-tooltip relative">
                                                <span className="text-blue-500 cursor-help"><i className="fas fa-question-circle"></i> Ayuda</span>
                                                <div className="tooltip whitespace-pre-wrap">{amountHelpText}</div>
                                            </div>
                                        </label>
                                        
                                        <div className="relative">
                                            <input 
                                                type="number"
                                                value={amount}
                                                onChange={(e) => setAmount(e.target.value)}
                                                placeholder="0.00"
                                                className="w-full p-3 pl-8 bg-white border border-slate-300 rounded-lg text-lg font-bold text-slate-800 focus:ring-2 focus:ring-blue-500 outline-none shadow-sm"
                                            />
                                            <span className="absolute left-3 top-4 text-slate-400">€</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* PANEL 2: MODERACIÓN */}
                            <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                                <div className="flex justify-between items-center mb-4 border-b pb-2">
                                    <h2 className="text-sm font-bold text-slate-800 uppercase flex items-center">
                                        <span className="bg-slate-200 text-slate-600 rounded-full w-5 h-5 flex items-center justify-center text-xs mr-2">2</span>
                                        Grado de Intervención
                                    </h2>
                                    <span className={`text-xs font-bold px-2 py-1 rounded border ${selectedScenario.color.replace('text-', 'text-').replace('bg-', 'bg-')}`}>
                                        {customMod}%
                                    </span>
                                </div>

                                <div className="grid grid-cols-2 gap-2 mb-4">
                                    {SCENARIOS.map((sc) => (
                                        <button
                                            key={sc.pct}
                                            onClick={() => handleScenarioClick(sc)}
                                            className={`scenario-btn p-2 rounded-lg border text-left text-xs relative ${customMod === sc.pct ? `bg-blue-50 border-blue-500 ring-1 ring-blue-500` : 'bg-white border-slate-200 hover:border-blue-300'}`}
                                        >
                                            <div className="font-bold text-slate-700">{sc.label}</div>
                                            <div className="text-slate-400 font-mono mt-1">{sc.pct}%</div>
                                            {customMod === sc.pct && <i className="fas fa-check-circle absolute top-2 right-2 text-blue-500"></i>}
                                        </button>
                                    ))}
                                </div>

                                <div className={`p-3 rounded-lg border text-xs leading-relaxed fade-in mb-4 ${selectedScenario.color}`}>
                                    <strong className="block mb-1"><i className="fas fa-info-circle mr-1"></i> Detalle Criterio:</strong>
                                    {selectedScenario.desc}
                                </div>

                                <input type="range" min="0" max="100" step="1" value={customMod} onChange={handleSliderChange} className="w-full" />
                            </div>
                        </div>

                        {/* RIGHT COLUMN: RESULTS */}
                        <div className="lg:col-span-4 space-y-6">
                            
                            {/* TOTAL CARD */}
                            {details && (
                                <div className="bg-slate-800 text-white p-6 rounded-xl shadow-lg relative overflow-hidden fade-in">
                                    <div className="relative z-10">
                                        <h3 className="text-slate-400 text-xs font-bold uppercase tracking-widest mb-1">Honorarios Totales</h3>
                                        <div className="flex items-end gap-2 mb-1">
                                            <span className="text-4xl font-extrabold tracking-tight">
                                                {details.grandTotal.toLocaleString('es-ES', { style: 'currency', currency: 'EUR' })}
                                            </span>
                                        </div>
                                        <p className="text-slate-400 text-xs mb-4">{includeVAT ? '(Incluye 21% IVA)' : '(Base Imponible)'}</p>
                                        <div className="pt-4 border-t border-slate-600 space-y-1 text-sm">
                                            <div className="flex justify-between text-slate-300">
                                                <span>Honorarios Netos:</span>
                                                <span className="font-mono text-white">{details.finalBase.toLocaleString('es-ES', {minimumFractionDigits: 2})}€</span>
                                            </div>
                                            <div className="flex justify-between items-center mt-2">
                                                <span className="text-slate-300 text-xs">Incluir IVA</span>
                                                <button onClick={() => setIncludeVAT(!includeVAT)} className={`w-8 h-4 rounded-full p-0.5 transition-colors ${includeVAT ? 'bg-green-500' : 'bg-slate-500'}`}><div className={`w-3 h-3 bg-white rounded-full shadow transform transition-transform ${includeVAT ? 'translate-x-4' : 'translate-x-0'}`}></div></button>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="absolute -bottom-6 -right-6 text-slate-700 opacity-20"><i className="fas fa-file-invoice text-9xl"></i></div>
                                </div>
                            )}

                            {/* ALERTAS LÍMITE */}
                            {details && details.cappedByLimit && (
                                <div className="bg-red-50 border-l-4 border-red-500 p-4 rounded shadow-sm fade-in">
                                    <div className="flex">
                                        <div className="flex-shrink-0">
                                            <i className="fas fa-gavel text-red-500"></i>
                                        </div>
                                        <div className="ml-3">
                                            <p className="text-sm text-red-700 font-bold">
                                                Límite Legal Aplicado (Art. 394.3 LEC)
                                            </p>
                                            <p className="text-xs text-red-600 mt-1">
                                                Los honorarios excedían la tercera parte de la cuantía ({details.preCapBase.toLocaleString('es-ES', {maximumFractionDigits:0})}€). Se ha reducido al máximo legal: <strong>{details.oneThirdLimit.toLocaleString('es-ES', {maximumFractionDigits:2})}€</strong>.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* BREAKDOWN */}
                            {details && (
                                <div className="bg-white p-5 rounded-xl shadow-sm border border-slate-200 text-sm fade-in">
                                    <h3 className="font-bold text-slate-700 mb-3 flex items-center"><i className="fas fa-list-ol text-blue-500 mr-2"></i> Desglose</h3>
                                    
                                    {!currentProcedure.isFixedBase && (
                                        <div className="mb-4">
                                            <div className="flex justify-between text-xs font-bold text-slate-400 uppercase mb-1"><span>Escala Base</span><span>Cuota</span></div>
                                            <div className="max-h-32 overflow-y-auto space-y-1 pr-1 custom-scrollbar border-b border-slate-100 pb-2">
                                                {details.breakdown.map((row, i) => (
                                                    <div key={i} className="flex justify-between text-xs text-slate-600 py-0.5">
                                                        <span>{row.range} <span className="text-blue-500">({row.pct}%)</span></span>
                                                        <span className="font-mono">{row.fee.toLocaleString('es-ES', {maximumFractionDigits:0})}€</span>
                                                    </div>
                                                ))}
                                            </div>
                                            <div className="flex justify-between font-bold text-slate-700 mt-2"><span>Total Escala:</span><span>{details.scaleTotal.toLocaleString('es-ES', {minimumFractionDigits: 2})}€</span></div>
                                        </div>
                                    )}

                                    <div className="space-y-2 bg-slate-50 p-3 rounded-lg border border-slate-100">
                                        <div className="flex justify-between items-center text-xs text-slate-600">
                                            <span>Procedimiento ({currentProcedure.mod}%)</span>
                                            <span className="font-mono">{details.reducedByCrit.toLocaleString('es-ES', {minimumFractionDigits: 2})}€</span>
                                        </div>
                                        <div className="flex justify-between items-center text-blue-600 font-bold text-xs">
                                            <span>Ajuste ({customMod}%)</span>
                                            <span className="font-mono">{details.preCapBase.toLocaleString('es-ES', {minimumFractionDigits: 2})}€</span>
                                        </div>
                                        {details.minApplied && <div className="mt-2 bg-yellow-50 text-yellow-700 p-2 rounded text-[10px] border border-yellow-100"><i className="fas fa-exclamation-triangle mr-1"></i> <strong>Mínimo Aplicado:</strong> El cálculo era inferior al valor de referencia ({details.effectiveMin.toLocaleString()}€).</div>}
                                    </div>
                                </div>
                            )}

                            {/* CHAT INTEGRADO AQUÍ AL FINAL DE LA COLUMNA DERECHA */}
                            <ChatEmbedded />
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>
