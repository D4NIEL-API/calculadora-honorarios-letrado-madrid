<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CALCULADORA HONORARIOS LETRADO (MADRID) POR DBS</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', system-ui, sans-serif; background-color: #f1f5f9; }
        .mode-btn-active { background-color: #1e3a8a; color: #ffffff; border: 1px solid #1e3a8a; box-shadow: 0 4px 6px -1px rgba(30, 58, 138, 0.4); font-weight: 700; }
        .mode-btn-inactive { background-color: white; color: #475569; border: 1px solid #cbd5e1; }
        .mode-btn-inactive:hover { background-color: #f8fafc; border-color: #94a3b8; color: #1e293b; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* Chat Styles */
        .chat-window { position: fixed; bottom: 90px; right: 24px; left: auto; width: 350px; height: 500px; background-color: white; border-radius: 16px; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); border: 1px solid #e2e8f0; z-index: 50; display: flex; flex-direction: column; overflow: hidden; }
        .chat-fab { position: fixed; bottom: 24px; right: 24px; left: auto; background-color: #2563eb; color: white; padding: 12px 20px; border-radius: 9999px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); cursor: pointer; z-index: 50; display: flex; align-items: center; gap: 8px; font-weight: 600; }
        .chat-bubble { max-width: 85%; padding: 10px 14px; border-radius: 12px; font-size: 0.85rem; line-height: 1.5; margin-bottom: 8px; }
        .chat-user { background-color: #1e3a8a; color: white; align-self: flex-end; }
        .chat-ai { background-color: #f1f5f9; color: #334155; align-self: flex-start; }
        .typing-dot { width: 5px; height: 5px; background: #94a3b8; border-radius: 50%; animation: typing 1.4s infinite ease-in-out both; margin: 0 2px; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        /* Slider */
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #1e3a8a; cursor: pointer; margin-top: -6px; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #cbd5e1; border-radius: 2px; }
        /* Toggle */
        .toggle-checkbox:checked { right: 0; border-color: #16a34a; }
        .toggle-checkbox:checked + .toggle-label { background-color: #16a34a; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- GEMINI API SETUP ---
        const BACKEND_URL = "https://backend-honorarios-letrado.onrender.com/api/chat";

        async function chatWithGemini(messages) {
            try {
                const contents = messages.map(msg => ({
                    role: msg.role === 'user' ? 'user' : 'model',
                    parts: [{ text: msg.content }]
                }));
                const response = await fetch(BACKEND_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ contents })
                });
                if (!response.ok) throw new Error("Error servidor");
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "Error al procesar la respuesta.";
            } catch (error) {
                console.error(error);
                return "Error de conexión con el Asistente Jurídico.";
            }
        }

        const SCALE_2013 = [
            { limit: 4000, percent: 25 }, { limit: 18000, percent: 18 }, { limit: 30000, percent: 16 }, 
            { limit: 45000, percent: 14 }, { limit: 60000, percent: 12 }, { limit: 90000, percent: 10 }, 
            { limit: 120000, percent: 9 }, { limit: 180000, percent: 8 }, { limit: 240000, percent: 7 }, 
            { limit: 300000, percent: 6 }, { limit: 450000, percent: 5.5 }, { limit: 600000, percent: 5 }, 
            { limit: 750000, percent: 4.5 }, { limit: 900000, percent: 4 }, { limit: 1050000, percent: 3.5 }, 
            { limit: 1200000, percent: 3 }, { limit: 1500000, percent: 2.5 }, { limit: 1800000, percent: 2 }, 
            { limit: 2100000, percent: 1.5 }, { limit: 2400000, percent: 1 }, { limit: 2700000, percent: 0.5 }
        ];

        const MODES = {
            CIVIL: { id: 'CIVIL', label: 'Civil / Mercantil', icon: 'fa-scale-balanced' },
            PENAL: { id: 'PENAL', label: 'Penal', icon: 'fa-gavel' },
            CONTENCIOSO: { id: 'CONTENCIOSO', label: 'Contencioso-Adm.', icon: 'fa-building-columns' },
            SOCIAL: { id: 'SOCIAL', label: 'Social (Laboral)', icon: 'fa-users' },
        };

        const PROCEDURES = {
            CIVIL: [
               { category: 'Declarativos' },
                { id: 'c4_ordinario', label: 'Juicio Ordinario (Criterio 4)', min: 2100, mod: 100 },
                { id: 'c5_verbal', label: 'Juicio Verbal (Criterio 5)', min: 1200, mod: 100 },
                { id: 'c5_desahucio_no_op', label: 'Desahucio (Sin Oposición)', min: 600, mod: 50 },
                { id: 'c5_desahucio_op', label: 'Desahucio (Con Vista)', min: 900, mod: 100 },
                { id: 'c23_monitorio', label: 'Monitorio (Sin Oposición)', min: 400, mod: 25 },
                { id: 'c18_familia', label: 'Familia (Contencioso)', min: 2500, mod: 100, isFixedBase: true },
                { category: 'Ejecuciones' },
                { id: 'c15_ejec_din_op', label: 'Ejec. Dineraria (Con Oposición)', min: 1200, mod: 50 },
                { id: 'c15_ejec_din_integra', label: 'Ejec. Vía Apremio (Completa)', min: 1200, mod: 75 },
                { id: 'c15_hipotecario', label: 'Ejecución Hipotecaria', min: 1200, mod: 75 },
                { category: 'Recursos' },
                { id: 'c7_apelacion', label: 'Apelación (Audiencia Provincial)', min: 1200, mod: 50 },
                { id: 'c9_casacion', label: 'Casación / Extraordinario', min: 3200, mod: 85 },
                { category: 'Incidentes' },
                { id: 'c2_incidente', label: 'Incidente / Tasación Costas', min: 450, mod: 20 },
            ],
            PENAL: [
                { id: 'c85_rc_instancia', label: 'Resp. Civil en Sentencia', min: 0, mod: 70 },
                { id: 'c35_instruccion', label: 'Instrucción / Escritos Acusación', min: 550, mod: 100, isFixedBase: true },
                { id: 'c37_juicio_oral', label: 'Asistencia Juicio Oral (Penal)', min: 650, mod: 100, isFixedBase: true },
            ],
            CONTENCIOSO: [
                { id: 'c89_ordinario', label: 'Procedimiento Ordinario', min: 2100, mod: 100 },
                { id: 'c90_abreviado', label: 'Procedimiento Abreviado', min: 1200, mod: 100 },
                { id: 'c93_apelacion_cont', label: 'Apelación Contencioso', min: 1200, mod: 50 },
            ],
            SOCIAL: [
                { id: 'c99_cantidad', label: 'Reclamación de Cantidad', min: 600, mod: 100 },
                { id: 'c101_despido', label: 'Despido', min: 900, mod: 100 },
                { id: 'c109_suplicacion', label: 'Recurso de Suplicación', min: 1200, mod: 50 },
            ],
        };

        // --- CALCULADORA CORE (Retorna objeto) ---
        function calculateConcept(amount, procId, jurisdiction, modPct) {
            const proc = PROCEDURES[jurisdiction].find(p => p.id === procId) || PROCEDURES[jurisdiction][1];
            const numericAmount = parseFloat(amount) || 0;
            
            // 1. Cálculo Base
            let calculatedBase = 0;

            if (proc.isFixedBase) {
                // Base fija (Ej: Penal, Familia sin cuantía)
                calculatedBase = proc.min * (modPct / 100);
            } else {
                // Escala 2013
                let remaining = numericAmount;
                let scaleAccumulator = 0;
                let prevLimit = 0;

                for (let tier of SCALE_2013) {
                    if (remaining <= 0) break;
                    let amountInTier = (tier.limit === 2700000 && numericAmount > 2700000) ? numericAmount - prevLimit : (numericAmount > tier.limit) ? (tier.limit - prevLimit) : (numericAmount - prevLimit);
                    const fee = amountInTier * (tier.percent / 100);
                    if (amountInTier > 0) {
                        scaleAccumulator += fee;
                        remaining -= amountInTier;
                    }
                    prevLimit = tier.limit;
                }
                
                // Aplicar porcentaje del trámite
                calculatedBase = scaleAccumulator * (modPct / 100);
                
                // Aplicar Mínimos
                let effectiveMin = proc.min * (modPct / 100);
                if (effectiveMin < 100 && numericAmount > 0) effectiveMin = 100; // Mínimo absoluto
                if (calculatedBase < effectiveMin && numericAmount > 0) calculatedBase = effectiveMin;
            }

            return {
                base: calculatedBase,
                procLabel: proc.label,
                amount: numericAmount
            };
        }

        // --- CHAT SIDEBAR (COPILOTO) ---
        function ChatSidebar() {
            const [messages, setMessages] = useState([
                { role: 'model', content: 'Hola, soy tu Asistente de Honorarios. ¿En qué te puedo ayudar? (Ej: "Tengo un desahucio con oposición de 600€ de renta")' }
            ]);
            const [inputValue, setInputValue] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const messagesEndRef = useRef(null);

            useEffect(() => { messagesEndRef.current?.scrollIntoView({ behavior: "smooth" }); }, [messages]);

            const handleSend = async (e) => {
                e.preventDefault();
                if (!inputValue.trim()) return;
                const newMessages = [...messages, { role: 'user', content: inputValue }];
                setMessages(newMessages);
                setInputValue('');
                setIsLoading(true);
                const responseText = await chatWithGemini(newMessages);
                setMessages(prev => [...prev, { role: 'model', content: responseText }]);
                setIsLoading(false);
            };

            return (
                <div className="relative flex flex-col h-[calc(100%-2rem)] bg-white m-4 rounded-xl shadow-lg border border-slate-200 overflow-hidden">
                    <div className="bg-slate-800 text-white p-4 border-b border-slate-700 flex justify-between items-center">
                        <h3 className="font-bold text-sm flex items-center">
                            <i className="fas fa-robot mr-2 text-blue-400"></i> Asistente Honorarios
                        </h3>
                    </div>
                    <div className="flex-1 overflow-y-auto p-4 pb-40 bg-slate-50 space-y-4">
                                {messages.map((msg, idx) => (
                                    <div key={idx} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                        <div className={`chat-bubble ${msg.role === 'user' ? 'chat-user shadow-md' : 'chat-ai shadow-sm markdown-chat'}`}>
                                            {msg.role === 'model' ? <div dangerouslySetInnerHTML={{ __html: marked.parse(msg.content) }} /> : msg.content}
                                        </div>
                                    </div>
                                ))}
                                {isLoading && <div className="flex justify-start"><div className="bg-white p-3 rounded-2xl rounded-bl-none shadow-sm flex gap-1"><div className="typing-dot"></div><div className="typing-dot"></div><div className="typing-dot"></div></div></div>}
                                <div ref={messagesEndRef} />
                            </div>
                    <form onSubmit={handleSend} className="absolute bottom-0 left-0 w-full p-5 bg-slate-100 border-t border-slate-200 z-10">
                        <div className="relative">
                            <textarea 
                                value={inputValue} 
                                onChange={(e) => setInputValue(e.target.value)} 
                                onKeyDown={(e) => {
                                    if (e.key === 'Enter' && !e.shiftKey) {
                                        e.preventDefault();
                                        handleSend(e);
                                    }
                                }}
                                placeholder="Describe tu caso aquí con todo detalle..." 
                                rows="3"
                                className="w-full pl-4 pr-14 py-3 bg-white border-2 border-slate-400 rounded-xl text-slate-800 placeholder-slate-500 focus:outline-none focus:border-blue-600 focus:ring-4 focus:ring-blue-100 transition-all shadow-lg resize-none text-sm leading-relaxed" 
                            />
                            <button 
                                type="submit" 
                                disabled={!inputValue.trim() || isLoading} 
                                className="absolute right-3 bottom-3 p-2 w-10 h-10 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed shadow-md transition-all flex items-center justify-center"
                            >
                                <i className="fas fa-paper-plane text-lg"></i>
                            </button>
                        </div>
                    </form>
                </div>
            );
        }

        // --- LOGIN ---
        function LoginScreen({ onLogin }) {
            const [password, setPassword] = useState("");
            const [error, setError] = useState(false);
            const handleSubmit = (e) => { 
                e.preventDefault(); 
                if (password === "DBS26") {
                    onLogin(); 
                } else {
                    setError(true);
                    setPassword("");
                }
            };
            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-100 p-4">
                    <form onSubmit={handleSubmit} className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm text-center">
                        <div className="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-6 text-blue-600 text-2xl"><i className="fas fa-lock"></i></div>
                        <input type="password" value={password} onChange={(e) => { setPassword(e.target.value); setError(false); }} placeholder="Contraseña" className={`w-full p-3 mb-2 rounded-lg border text-center font-mono focus:ring-2 focus:ring-blue-500 ${error ? 'border-red-500' : 'border-slate-300'}`} />
                        {error && <p className="text-red-500 text-xs font-bold mb-4">Contraseña incorrecta. Inténtelo de nuevo.</p>}
                        <button type="submit" className="w-full bg-blue-600 text-white font-bold py-3 rounded-lg">Entrar</button>
                    </form>
                </div>
            );
        }

        function App() {
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            
            // ESTADO MULTI-CONCEPTO
            const [concepts, setConcepts] = useState([]); // Lista de conceptos agregados
            const [calculationMode, setCalculationMode] = useState('COSTAS'); // 'PRESUPUESTO' | 'COSTAS'
            const [beneficiaryType, setBeneficiaryType] = useState('PHYSICAL'); // 'PHYSICAL' | 'LEGAL'
            const [applyLimit394, setApplyLimit394] = useState(false);
            const [manualIVA, setManualIVA] = useState(true);
            
            // ESTADO FORMULARIO (INPUTS)
            const [jurisdiction, setJurisdiction] = useState('CIVIL');
            const [selectedProcId, setSelectedProcId] = useState('c4_ordinario'); 
            const [amount, setAmount] = useState('');
            const [customMod, setCustomMod] = useState(100);

            // Defaults al cambiar jurisdicción
            useEffect(() => {
                const firstProc = PROCEDURES[jurisdiction][0]?.category ? PROCEDURES[jurisdiction][1] : PROCEDURES[jurisdiction][0];
                if (firstProc) { setSelectedProcId(firstProc.id); setCustomMod(firstProc.mod); }
            }, [jurisdiction]);

            useEffect(() => {
                const proc = PROCEDURES[jurisdiction].find(p => p.id === selectedProcId);
                if (proc) setCustomMod(proc.mod);
            }, [selectedProcId]);

            // Sincronización Inteligente de IVA
            useEffect(() => {
                if (calculationMode === 'PRESUPUESTO') {
                    setManualIVA(true);
                } else {
                    setManualIVA(beneficiaryType === 'PHYSICAL');
                }
            }, [calculationMode, beneficiaryType]);

            // ACCIONES
            const addConcept = () => {
                const result = calculateConcept(amount, selectedProcId, jurisdiction, customMod);
                const newConcept = {
                    id: Date.now(),
                    label: result.procLabel,
                    amount: result.amount,
                    mod: customMod,
                    fee: result.base
                };
                setConcepts([...concepts, newConcept]);
                setAmount(''); // Reset input
            };

            const removeConcept = (id) => {
                setConcepts(concepts.filter(c => c.id !== id));
            };

            // CÁLCULOS GLOBALES
            const totalFees = concepts.reduce((acc, curr) => acc + curr.fee, 0);
            
            // Lógica Art 394.3: Límite es 1/3 de la cuantía PRINCIPAL. 
            // SIMPLIFICACIÓN: Tomamos la cuantía mayor como la "Principal" para el límite.
            const maxAmount = concepts.reduce((max, curr) => (curr.amount > max ? curr.amount : max), 0);
            const limitValue = maxAmount / 3;
            
            let finalBase = totalFees;
            let isCapped = false;

            if (applyLimit394 && maxAmount > 0 && totalFees > limitValue) {
                finalBase = limitValue;
                isCapped = true;
            }

            // Feedback Visual del IVA (Cerebro Fiscal)
            const vatReason = useMemo(() => {
                // CASO 1: Presupuesto a Cliente Propio
                if (calculationMode === 'PRESUPUESTO') {
                    return "IVA Incluido (Obligatorio en facturación a cliente)";
                }

                // CASO 2: Tasación de Costas (Paga la contraria)
                if (calculationMode === 'COSTAS') {
                    if (beneficiaryType === 'LEGAL') {
                        return "IVA excluido: Según doctrina del TS, el IVA no es gasto necesario si el vencedor puede deducirlo íntegramente.";
                    } else {
                        return "IVA Incluido (Beneficiario particular / consumidor final)";
                    }
                }
                return "";
            }, [calculationMode, beneficiaryType]);

            const vatAmount = manualIVA ? finalBase * 0.21 : 0;
            const grandTotal = finalBase + vatAmount;

            const handleCopy = () => {
                // Función para limpiar "(Criterio XX)" del nombre del procedimiento
                const cleanLabel = (text) => text.replace(/\s*\(Criterio\s*[\d.]+\)/gi, "").trim();

                let text = "DESGLOSE PROFESIONAL DE HONORARIOS\n";
                text += "==================================\n\n";
                
                concepts.forEach(c => {
                    const nombreLimpio = cleanLabel(c.label);
                    text += `• ${nombreLimpio.toUpperCase()}\n`;
                    text += `  Base: ${c.amount.toLocaleString('es-ES')} € | Aplicado: ${c.mod}%\n`;
                    text += `  Subtotal: ${c.fee.toLocaleString('es-ES', {minimumFractionDigits: 2})} €\n\n`;
                });

                text += "----------------------------------\n";
                text += `SUMA DE HONORARIOS: ${totalFees.toLocaleString('es-ES', {minimumFractionDigits: 2})} €\n`;
                
                if (isCapped) {
                    text += `REDUCCIÓN ART. 394.3 LEC: -${(totalFees - limitValue).toLocaleString('es-ES', {minimumFractionDigits: 2})} €\n`;
                    text += `BASE IMPONIBLE FINAL: ${finalBase.toLocaleString('es-ES', {minimumFractionDigits: 2})} €\n`;
                }

                if (manualIVA) {
                    text += `IVA (21%): ${vatAmount.toLocaleString('es-ES', {minimumFractionDigits: 2})} €\n`;
                }

                text += `TOTAL EXPEDIENTE: ${grandTotal.toLocaleString('es-ES', {minimumFractionDigits: 2})} €\n`;
                text += "----------------------------------";

                navigator.clipboard.writeText(text);
                alert("Cálculo profesional copiado (sin referencias a criterios)");
            };

            if (!isAuthenticated) return <LoginScreen onLogin={() => setIsAuthenticated(true)} />;

            return (
                <div className="flex h-screen bg-slate-50 overflow-hidden fade-in">
                    {/* COLUMNA IZQUIERDA: WORKSPACE */}
                    <div className="flex-1 h-full overflow-y-auto p-4 lg:p-8 scroll-smooth">
                        <div className="max-w-7xl mx-auto space-y-6">
                        
                            {/* FILA SUPERIOR: CALCULADORA Y REGLAS */}
                            <div className="grid grid-cols-1 2xl:grid-cols-2 gap-6 items-start">
                                {/* 1. CALCULADORA */}
                                <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                                <h1 className="font-extrabold text-slate-800 text-lg uppercase mb-4">Calculadora Honorarios DBS</h1>
                                
                                {/* 0. CONFIGURACIÓN GLOBAL (PROTECCIÓN FISCAL) */}
                                <div className="mb-6 bg-slate-50 p-4 rounded-xl border border-slate-200 space-y-3">
                                    <div>
                                        <label className="block text-[10px] font-bold text-slate-400 uppercase mb-2 tracking-wider">Modo de Cálculo</label>
                                        <div className="flex gap-2">
                                            <button 
                                                onClick={() => setCalculationMode('PRESUPUESTO')} 
                                                className={`flex-1 py-2.5 px-2 rounded-lg flex items-center justify-center gap-2 border transition-all ${calculationMode === 'PRESUPUESTO' ? 'bg-slate-800 text-white border-slate-900 shadow-md' : 'bg-white text-slate-600 border-slate-200 hover:bg-slate-50'}`}
                                            >
                                                <i className="fas fa-file-invoice-dollar"></i>
                                                <span className="text-xs font-bold uppercase">Presupuesto</span>
                                            </button>
                                            <button 
                                                onClick={() => setCalculationMode('COSTAS')} 
                                                className={`flex-1 py-2.5 px-2 rounded-lg flex items-center justify-center gap-2 border transition-all ${calculationMode === 'COSTAS' ? 'bg-slate-800 text-white border-slate-900 shadow-md' : 'bg-white text-slate-600 border-slate-200 hover:bg-slate-50'}`}
                                            >
                                                <i className="fas fa-gavel"></i>
                                                <span className="text-xs font-bold uppercase">Costas</span>
                                            </button>
                                        </div>
                                    </div>

                                    {calculationMode === 'PRESUPUESTO' ? (
                                        <div className="bg-green-50 border border-green-200 p-3 rounded-lg flex items-center gap-2 fade-in">
                                            <i className="fas fa-check-circle text-green-500"></i>
                                            <span className="text-[10px] font-bold text-green-700 uppercase">Aplicando IVA General (21%)</span>
                                        </div>
                                    ) : (
                                        <div className="fade-in">
                                            <label className="block text-[10px] font-bold text-slate-400 uppercase mb-2 tracking-wider">Beneficiario (Receptor del pago)</label>
                                            <div className="flex gap-2">
                                                <button onClick={() => setBeneficiaryType('PHYSICAL')} className={`flex-1 py-2 text-[10px] font-bold rounded border transition-all ${beneficiaryType === 'PHYSICAL' ? 'bg-blue-50 text-blue-700 border-blue-300' : 'bg-white border-slate-200 text-slate-500'}`}>
                                                    <i className="fas fa-user mr-1"></i> Particular
                                                </button>
                                                <button onClick={() => setBeneficiaryType('LEGAL')} className={`flex-1 py-2 text-[10px] font-bold rounded border transition-all ${beneficiaryType === 'LEGAL' ? 'bg-purple-50 text-purple-700 border-purple-300' : 'bg-white border-slate-200 text-slate-500'}`}>
                                                    <i className="fas fa-building mr-1"></i> Empresa
                                                </button>
                                            </div>
                                        </div>
                                    )}

                                    <div className={`text-[9px] font-bold px-2 py-2 rounded border flex items-center gap-1.5 ${manualIVA ? 'bg-blue-50 text-blue-600 border-blue-100' : 'bg-orange-50 text-orange-600 border-orange-100'}`}>
                                        <i className={`fas ${manualIVA ? 'fa-info-circle' : 'fa-shield-halved'}`}></i>
                                        {vatReason}
                                    </div>
                                </div>

                                {/* 1. JURISDICCIÓN */}
                                <div className="grid grid-cols-4 gap-1 mb-4">
                                    {Object.values(MODES).map((m) => (
                                        <button key={m.id} onClick={() => setJurisdiction(m.id)} className={`py-2 rounded flex flex-col items-center justify-center text-[10px] font-bold transition-all ${jurisdiction === m.id ? 'bg-slate-800 text-white' : 'bg-slate-100 text-slate-500 hover:bg-slate-200'}`}>
                                            <i className={`fas ${m.icon} text-sm mb-1`}></i> {m.label.split(' ')[0]}
                                        </button>
                                    ))}
                                </div>

                                {/* 2. CONCEPTO */}
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-xs font-bold text-slate-600 mb-1">Trámite</label>
                                        <select value={selectedProcId} onChange={(e) => setSelectedProcId(e.target.value)} className="w-full p-2 bg-white border border-slate-300 rounded text-sm">
                                            {PROCEDURES[jurisdiction].map((p, idx) => (
                                                p.category ? <optgroup key={idx} label={p.category} /> : <option key={p.id} value={p.id}>{p.label}</option>
                                            ))}
                                        </select>
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-xs font-bold text-slate-600 mb-1">Cuantía (€)</label>
                                            <input type="number" value={amount} onChange={(e) => setAmount(e.target.value)} placeholder="0.00" className="w-full p-2 border border-slate-300 rounded text-sm font-bold" />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-slate-600 mb-1">% Escala</label>
                                            <input type="number" value={customMod} onChange={(e) => setCustomMod(e.target.value)} className="w-full p-2 border border-slate-300 rounded text-sm text-center" />
                                        </div>
                                    </div>
                                </div>
                            </div>

                                {/* 2. REGLAS ESPECIALES */}
                                <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 h-full">
                                <h2 className="text-sm font-bold text-slate-800 uppercase mb-4 border-b pb-2 flex items-center">
                                    Ajustes Legales
                                </h2>
                                <div className="space-y-4">
                                    <div className="flex items-center justify-between">
                                        <span className="text-xs font-bold text-slate-600">Límite legal (Art. 394.3 LEC)</span>
                                        <label className="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" className="sr-only" checked={applyLimit394} onChange={() => setApplyLimit394(!applyLimit394)} />
                                            <div className={`w-10 h-6 rounded-full p-1 transition-colors ${applyLimit394 ? 'bg-blue-600' : 'bg-slate-300'}`}>
                                                <div className={`bg-white w-4 h-4 rounded-full shadow-md transform transition-transform ${applyLimit394 ? 'translate-x-4' : ''}`}></div>
                                            </div>
                                        </label>
                                    </div>
                                    <div className="flex items-center justify-between">
                                        <span className="text-xs font-bold text-slate-600">IVA (21%)</span>
                                        <label className="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" className="sr-only" checked={manualIVA} onChange={() => setManualIVA(!manualIVA)} />
                                            <div className={`w-10 h-6 rounded-full p-1 transition-colors ${manualIVA ? 'bg-blue-600' : 'bg-slate-300'}`}>
                                                <div className={`bg-white w-4 h-4 rounded-full shadow-md transform transition-transform ${manualIVA ? 'translate-x-4' : ''}`}></div>
                                            </div>
                                        </label>
                                    </div>

                                    <button onClick={addConcept} className="w-full bg-blue-600 text-white font-bold py-3 rounded-lg shadow-md hover:bg-blue-700 transition active:scale-95">
                                        <i className="fas fa-plus-circle mr-2"></i> AÑADIR CONCEPTO
                                    </button>
                                </div>
                            </div>
                            </div>

                            {/* FILA INFERIOR: DESGLOSE */}
                            <div className="space-y-6">
                            {/* LISTA CONCEPTOS */}
                            <div className="bg-white p-6 rounded-xl shadow-md border-2 border-slate-300 min-h-[300px]">
                                <h2 className="text-xs font-bold text-slate-400 uppercase mb-4 tracking-wider">Desglose del Expediente</h2>
                                
                                {concepts.length === 0 ? (
                                    <div className="text-center py-12 text-slate-400 border-4 border-dashed border-slate-200 rounded-xl">
                                        <i className="fas fa-calculator text-5xl mb-4 opacity-50"></i>
                                        <p className="text-lg text-slate-500 font-medium">Configura los parámetros y pulsa 'Añadir Concepto' para comenzar el cálculo.</p>
                                    </div>
                                ) : (
                                    <div className="space-y-2">
                                        {concepts.map((c) => (
                                            <div key={c.id} className="flex justify-between items-center bg-slate-50 p-3 rounded border border-slate-100 animate-fade-in">
                                                <div>
                                                    <div className="font-bold text-slate-700 text-sm">{c.label}</div>
                                                    <div className="text-xs text-slate-500">Base: {c.amount}€ | Escala: {c.mod}%</div>
                                                </div>
                                                <div className="flex items-center gap-4">
                                                    <span className="font-mono font-bold text-blue-600">{c.fee.toLocaleString('es-ES', {minimumFractionDigits: 2})} €</span>
                                                    <button onClick={() => removeConcept(c.id)} className="text-red-400 hover:text-red-600"><i className="fas fa-trash"></i></button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>

                            {/* TOTALES */}
                            {concepts.length > 0 && (
                                <div className="bg-slate-900 text-white p-6 rounded-xl shadow-lg animate-fade-in">
                                    <div className="flex justify-end items-center mb-4 pb-4 border-b border-slate-700">
                                        <button onClick={handleCopy} className="text-xs bg-slate-700 hover:bg-slate-600 px-3 py-1 rounded text-white"><i className="fas fa-copy mr-1"></i> Copiar</button>
                                    </div>

                                    <div className="space-y-1 text-sm">
                                        <div className="flex justify-between text-slate-400">
                                            <span>Suma Honorarios:</span>
                                            <span>{totalFees.toLocaleString('es-ES', {minimumFractionDigits: 2})} €</span>
                                        </div>
                                        {isCapped && (
                                            <div className="flex justify-between text-orange-400 font-bold">
                                                <span>Límite Legal (1/3):</span>
                                                <span>{limitValue.toLocaleString('es-ES', {minimumFractionDigits: 2})} €</span>
                                            </div>
                                        )}
                                        <div className="flex justify-between text-white font-bold text-lg pt-2 border-t border-slate-700">
                                            <span>Base Imponible:</span>
                                            <span>{finalBase.toLocaleString('es-ES', {minimumFractionDigits: 2})} €</span>
                                        </div>
                                        {manualIVA && (
                                            <div className="flex justify-between text-slate-400">
                                                <span>IVA (21%):</span>
                                                <span>{vatAmount.toLocaleString('es-ES', {minimumFractionDigits: 2})} €</span>
                                            </div>
                                        )}
                                        <div className="flex justify-between bg-blue-600 text-white font-extrabold text-2xl mt-4 p-4 rounded-lg shadow-md">
                                            <span>TOTAL:</span>
                                            <span>{grandTotal.toLocaleString('es-ES', {minimumFractionDigits: 2})} €</span>
                                        </div>
                                    </div>
                                </div>
                            )}
                            </div>
                        </div>
                    </div>

                    {/* COLUMNA DERECHA: CHAT SIDEBAR */}
                    <div className="hidden lg:flex w-[400px] xl:w-[450px] h-full bg-white border-l border-slate-200 shadow-xl z-20 relative">
                        <ChatSidebar />
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>